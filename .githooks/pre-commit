#!/bin/bash

# Pre-commit hook to enforce DesignTokens usage
# Prevents hardcoded design values from being committed

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ğŸ” Checking for hardcoded design values..."

# Get staged Swift files in Views directory
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'Zero_ios_2/Zero/Views/.*\.swift$')

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No View files changed"
    exit 0
fi

VIOLATIONS=0

# Check for hardcoded opacity values
echo ""
echo "Checking for hardcoded .opacity() values..."

for FILE in $STAGED_FILES; do
    # Look for .opacity() with literal numbers (not DesignTokens references)
    OPACITY_VIOLATIONS=$(git diff --cached "$FILE" | grep -E '^\+.*\.opacity\((0\.[0-9]+|1\.0|1)\)' | grep -v 'DesignTokens\.Opacity')

    if [ -n "$OPACITY_VIOLATIONS" ]; then
        echo ""
        echo -e "${RED}âŒ Hardcoded opacity in: $FILE${NC}"
        echo "$OPACITY_VIOLATIONS" | while read -r line; do
            # Extract the opacity value
            OPACITY=$(echo "$line" | grep -oE '\(0\.[0-9]+|1\.0|1\)' | tr -d '()')
            echo -e "${YELLOW}   Found: .opacity($OPACITY)${NC}"

            # Suggest the correct token
            case "$OPACITY" in
                "0.05") echo -e "${GREEN}   Use: DesignTokens.Opacity.glassUltraLight${NC}" ;;
                "0.1"|"0.10") echo -e "${GREEN}   Use: DesignTokens.Opacity.glassLight${NC}" ;;
                "0.2"|"0.20") echo -e "${GREEN}   Use: DesignTokens.Opacity.overlayLight${NC}" ;;
                "0.3"|"0.30") echo -e "${GREEN}   Use: DesignTokens.Opacity.overlayMedium${NC}" ;;
                "0.5"|"0.50") echo -e "${GREEN}   Use: DesignTokens.Opacity.overlayStrong${NC}" ;;
                "0.6"|"0.60") echo -e "${GREEN}   Use: DesignTokens.Opacity.textDisabled${NC}" ;;
                "0.7"|"0.70") echo -e "${GREEN}   Use: DesignTokens.Opacity.textSubtle${NC}" ;;
                "0.8"|"0.80") echo -e "${GREEN}   Use: DesignTokens.Opacity.textTertiary${NC}" ;;
                "0.9"|"0.90") echo -e "${GREEN}   Use: DesignTokens.Opacity.textSecondary${NC}" ;;
                "1"|"1.0"|"1.00") echo -e "${GREEN}   Use: DesignTokens.Opacity.textPrimary${NC}" ;;
                *) echo -e "${GREEN}   Use appropriate DesignTokens.Opacity value${NC}" ;;
            esac
        done
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
done

# Check for hardcoded cornerRadius values
echo ""
echo "Checking for hardcoded .cornerRadius() values..."

for FILE in $STAGED_FILES; do
    RADIUS_VIOLATIONS=$(git diff --cached "$FILE" | grep -E '^\+.*\.cornerRadius\([0-9]+\)' | grep -v 'DesignTokens\.Radius')

    if [ -n "$RADIUS_VIOLATIONS" ]; then
        echo ""
        echo -e "${RED}âŒ Hardcoded radius in: $FILE${NC}"
        echo "$RADIUS_VIOLATIONS" | while read -r line; do
            RADIUS=$(echo "$line" | grep -oE '\([0-9]+\)' | tr -d '()')
            echo -e "${YELLOW}   Found: .cornerRadius($RADIUS)${NC}"

            case "$RADIUS" in
                "4") echo -e "${GREEN}   Use: DesignTokens.Radius.minimal${NC}" ;;
                "8") echo -e "${GREEN}   Use: DesignTokens.Radius.chip${NC}" ;;
                "12") echo -e "${GREEN}   Use: DesignTokens.Radius.button${NC}" ;;
                "16") echo -e "${GREEN}   Use: DesignTokens.Radius.card${NC}" ;;
                "20") echo -e "${GREEN}   Use: DesignTokens.Radius.modal${NC}" ;;
                "999") echo -e "${GREEN}   Use: DesignTokens.Radius.circle${NC}" ;;
                *) echo -e "${GREEN}   Use appropriate DesignTokens.Radius value${NC}" ;;
            esac
        done
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
done

# Check for hardcoded padding values
echo ""
echo "Checking for hardcoded .padding() values..."

for FILE in $STAGED_FILES; do
    PADDING_VIOLATIONS=$(git diff --cached "$FILE" | grep -E '^\+.*\.padding\([0-9]+\)' | grep -v 'DesignTokens\.Spacing')

    if [ -n "$PADDING_VIOLATIONS" ]; then
        echo ""
        echo -e "${RED}âŒ Hardcoded padding in: $FILE${NC}"
        echo "$PADDING_VIOLATIONS" | while read -r line; do
            PADDING=$(echo "$line" | grep -oE '\([0-9]+\)' | tr -d '()')
            echo -e "${YELLOW}   Found: .padding($PADDING)${NC}"

            case "$PADDING" in
                "4") echo -e "${GREEN}   Use: DesignTokens.Spacing.minimal${NC}" ;;
                "6") echo -e "${GREEN}   Use: DesignTokens.Spacing.tight${NC}" ;;
                "8") echo -e "${GREEN}   Use: DesignTokens.Spacing.inline${NC}" ;;
                "12") echo -e "${GREEN}   Use: DesignTokens.Spacing.element${NC}" ;;
                "16") echo -e "${GREEN}   Use: DesignTokens.Spacing.component${NC}" ;;
                "20") echo -e "${GREEN}   Use: DesignTokens.Spacing.section${NC}" ;;
                "24") echo -e "${GREEN}   Use: DesignTokens.Spacing.card${NC}" ;;
                *) echo -e "${GREEN}   Use appropriate DesignTokens.Spacing value${NC}" ;;
            esac
        done
        VIOLATIONS=$((VIOLATIONS + 1))
    fi
done

# Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $VIOLATIONS -eq 0 ]; then
    echo -e "${GREEN}âœ… All checks passed! No hardcoded design values found.${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 0
else
    echo -e "${RED}âŒ Found $VIOLATIONS file(s) with hardcoded design values.${NC}"
    echo ""
    echo "Please use DesignTokens instead of hardcoded values."
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
fi
