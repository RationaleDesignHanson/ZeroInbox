name: Design Tokens Sync

# Automatically regenerate DesignTokens.swift when tokens.json changes
# Creates a PR with updated Swift code for review

on:
  push:
    branches: [master, main]
    paths:
      - 'design-system/tokens.json'
  pull_request:
    paths:
      - 'design-system/tokens.json'
  workflow_dispatch: # Allow manual trigger

jobs:
  generate-tokens:
    name: Generate Design Tokens
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better PR context

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'design-system/sync/package.json'

      - name: Install dependencies
        run: |
          cd design-system/sync
          if [ -f package.json ]; then
            npm ci
          fi

      - name: Generate Swift tokens
        run: |
          echo "ğŸ“¦ Generating DesignTokens.swift from tokens.json..."
          node design-system/sync/generate-swift.js
          echo "âœ… Generation complete"

      - name: Generate Web tokens
        run: |
          echo "ğŸ“¦ Generating Web tokens (CSS + JS)..."
          node design-system/sync/generate-web.js
          echo "âœ… Web tokens generated"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet design-system/generated/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected - tokens are up to date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected in generated files"
            git diff --stat design-system/generated/
          fi

      - name: Copy to iOS project
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "ğŸ“‹ Copying DesignTokens.swift to iOS project..."
          cp design-system/generated/DesignTokens.swift Zero_ios_2/Zero/Config/DesignTokens.swift
          echo "âœ… File copied"

      - name: Verify Swift compilation
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "ğŸ”¨ Verifying Swift project compiles..."
          xcodebuild -project Zero_ios_2/Zero/Zero.xcodeproj \
            -scheme Zero \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            build \
            -quiet
          echo "âœ… Build successful"

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update design tokens from tokens.json

            Auto-generated from design-system/tokens.json changes.

            Generated files:
            - DesignTokens.swift (iOS)
            - design-tokens.css (Web)
            - design-tokens.js (Web)

            Build verified: âœ… Xcode compilation successful

            ğŸ¤– Generated with GitHub Actions
          branch: auto/design-tokens-update
          delete-branch: true
          title: 'ğŸ¨ Update Design Tokens'
          body: |
            ## Auto-Generated Design Token Update

            This PR was automatically created because `design-system/tokens.json` changed.

            ### What Changed

            - âœ… Regenerated `DesignTokens.swift` from tokens.json
            - âœ… Regenerated Web tokens (CSS + JS)
            - âœ… Copied to `Zero_ios_2/Zero/Config/DesignTokens.swift`
            - âœ… Verified Xcode build compiles successfully

            ### Files Updated

            ```
            design-system/generated/DesignTokens.swift
            Zero_ios_2/Zero/Config/DesignTokens.swift
            design-system/generated/design-tokens.css
            design-system/generated/design-tokens.js
            ```

            ### Review Checklist

            - [ ] Token values look correct
            - [ ] No unintended changes
            - [ ] iOS build passes locally
            - [ ] Visual inspection of affected components

            ### How to Test

            ```bash
            # Pull this branch
            git fetch origin auto/design-tokens-update
            git checkout auto/design-tokens-update

            # Build and run iOS app
            cd Zero_ios_2
            open Zero.xcodeproj
            # Build and run on simulator
            ```

            ### Merging

            This PR can be safely merged if:
            1. âœ… Build is green
            2. âœ… Token values are correct
            3. âœ… No visual regressions

            ---

            ğŸ¤– Auto-generated by GitHub Actions
            ğŸ”— Workflow: `design-tokens-sync.yml`
          labels: |
            design-system
            auto-generated
            tokens
          assignees: ${{ github.actor }}

      - name: Comment on commit
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/commit-comment@v3
        with:
          body: |
            ## âœ… Design Tokens Updated

            Successfully regenerated design tokens from `tokens.json`.

            **Generated files:**
            - DesignTokens.swift (iOS)
            - design-tokens.css (Web)
            - design-tokens.js (Web)

            **Build status:** âœ… Xcode compilation successful

            A PR has been created for review: #${{ steps.create-pr.outputs.pull-request-number }}

      - name: Upload artifacts
        if: steps.changes.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-tokens
          path: |
            design-system/generated/
            Zero_ios_2/Zero/Config/DesignTokens.swift
          retention-days: 30

  lint-tokens:
    name: Lint tokens.json
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          echo "ğŸ” Validating tokens.json syntax..."
          jq empty design-system/tokens.json
          echo "âœ… JSON is valid"

      - name: Check required fields
        run: |
          echo "ğŸ” Checking required token fields..."

          # Check that all tokens have $value or nested tokens
          MISSING=$(jq -r '
            .. |
            objects |
            select(has("$value") | not) |
            select(to_entries | length == 0) |
            path | join(".")
          ' design-system/tokens.json)

          if [ -n "$MISSING" ]; then
            echo "âŒ Tokens missing $value:"
            echo "$MISSING"
            exit 1
          fi

          echo "âœ… All tokens have required fields"

      - name: Check for duplicates
        run: |
          echo "ğŸ” Checking for duplicate token names..."

          DUPLICATES=$(jq -r '
            [.. | objects | keys[]] |
            group_by(.) |
            map(select(length > 1) | .[0]) |
            .[]
          ' design-system/tokens.json | grep -v '^\$' || true)

          if [ -n "$DUPLICATES" ]; then
            echo "âš ï¸  Potential duplicate token names found:"
            echo "$DUPLICATES"
            echo "Note: This may be expected for nested structures"
          else
            echo "âœ… No duplicates found"
          fi

      - name: Report token stats
        run: |
          echo "ğŸ“Š Token Statistics:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo "Primitive tokens:"
          jq -r '.primitive | keys | length' design-system/tokens.json

          echo "Semantic tokens:"
          jq -r '[.spacing, .radius, .opacity] | map(keys | length) | add' design-system/tokens.json

          echo "Color tokens:"
          jq -r '.colors | .. | objects | select(has("$value")) | ."$value"' design-system/tokens.json | wc -l

          echo "Typography tokens:"
          jq -r '.typography | keys | length' design-system/tokens.json || echo "0"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
