# Routing System Audit - Week 2

## Executive Summary

Zero iOS currently has **TWO routing systems** running in parallel:
- **ModalRouter** (v1.0) - Legacy string-matching system
- **ActionRouter** (v1.2) - Modern registry-based system

**Finding**: ModalRouter is **effectively dead code** - never executed in practice.

---

## Current Architecture

### Routing Decision (ContentView.swift:187-194)

```swift
if let suggestedActions = card.suggestedActions, !suggestedActions.isEmpty {
    // Modern card → use ActionRouter
    actionRouterModalView(for: actionToExecute, card: card)
} else {
    // Legacy card → use ModalRouter
    let destination = ModalRouter.route(card: card, selectedActionId: viewState.selectedActionId)
    modalRouterView(for: destination)
}
```

###Analysis

**Key Finding**: ALL cards generated by DataGenerator include BOTH:
- `hpa: "View Summary"` (legacy field)
- `suggestedActions: [EmailAction]` (modern array)

**Result**: The `else` branch (ModalRouter path) is **NEVER EXECUTED** because:
1. DataGenerator creates all mock cards with `suggestedActions`
2. Backend returns emails with `suggestedActions` array
3. Condition `!suggestedActions.isEmpty` is always true

---

## ModalRouter (v1.0) - Legacy System

**File**: `Navigation/ModalRouter.swift` (669 lines)
**Status**: ⚠️ DEAD CODE - Never executed

### Architecture
- String-based pattern matching
- 50+ hardcoded modal destinations
- Complex conditional logic (200+ lines)
- Returns `ModalDestination` enum

### Example Routing Logic
```swift
if normalizedAction.contains("schedule_demo") ||
   normalizedAction.contains("schedule_review") ||
   normalizedAction.contains("schedule_call") ||
   normalizedAction.contains("book_meeting") ||
   normalizedAction.contains("arrange_meeting") {
    return .scheduleMeeting(card: card)
}
```

### Modal Destinations (50+ cases)
- documentViewer, spreadsheetViewer, scheduleMeeting, emailComposer
- signForm, openApp, openURL, addToCalendar, scheduledPurchase
- shoppingPurchase, snoozePicker, saveForLater, viewAttachments
- addReminder, addToWallet, browseShopping, cancelSubscription
- checkInFlight, contactDriver, newsletterSummary, payInvoice
- pickupDetails, quickReply, reservation, saveContact, sendMessage
- share, snooze, trackPackage, unsubscribe, writeReview
- addToNotes, provideAccessCode, viewActivity, saveProperties
- scheduleDeliveryTime, prepareForOutage, viewActivityDetails
- readCommunityPost, viewOutageDetails, viewPostComments
- shoppingAutomation

### Used By
1. **ContentView.swift** (line 189) - Legacy routing branch
2. **ModalViewBuilder.swift** - Converts ModalDestination → SwiftUI View

---

## ActionRouter (v1.2) - Current System

**File**: `Services/ActionRouter.swift` (906 lines)
**Status**: ✅ ACTIVE - Used by all modern cards

### Architecture
- Registry-based action lookup via ActionRegistry
- Validates mode compatibility (Mail vs Ads)
- Validates required context keys
- Applies placeholders for missing data
- Comprehensive analytics tracking
- Returns `ActionModal` enum

### Flow
```
User triggers action
    ↓
ActionRouter.executeAction(action, card, from: VC)
    ↓
1. Registry lookup: ActionRegistry.getAction(actionId)
2. Mode validation: isActionValidForMode()
3. Context validation: validateAction(actionId, context)
4. Placeholder fallback: ActionPlaceholders.applyPlaceholders()
5. Execute: handle GO_TO (URL) or IN_APP (modal)
6. Analytics: Track action execution
```

### Used By
1. **ContentView.swift** (line 183) - Modern routing branch (ALWAYS USED)
2. **ActionRegistry.swift** - Action definitions and validation
3. **ModalViewBuilder.swift** - Modal construction

---

## Dead Code in ActionRouter

### Unused ModalDestination Cases

ActionRouter has references to modal cases that **DO NOT EXIST** in ModalRouter.ModalDestination:

**File**: `Services/ActionRouter.swift:558-581`

```swift
case "RSVPModal":
    return .rsvp(card: card, response: actionId == "rsvp_yes")  // ❌ .rsvp doesn't exist

case "SecurityReviewModal":
    return .reviewSecurity(card: card, context: context)  // ❌ .reviewSecurity doesn't exist

case "UpdatePaymentModal":
    return .updatePayment(card: card, context: context)  // ❌ .updatePayment doesn't exist

case "ViewDetailsModal":
    return .viewDetails(card: card, context: context)  // ❌ .viewDetails doesn't exist (used as fallback)
```

**Impact**: These would cause **runtime crashes** if ever executed (enum case doesn't exist).

**Why no crashes?**: These code paths are never reached because:
1. Backend doesn't return these actionIds
2. ModalRouter is never used anyway (dead code)

---

## Files Using Each System

### ModalRouter References (5 files)
1. **Zero.xcodeproj/project.pbxproj** - Build system
2. **Zero/ContentView.swift** - Dead code branch (line 189)
3. **Navigation/ModalViewBuilder.swift** - View construction
4. **errorlogs.txt** - Logs (not code)
5. **xcode-file-list.txt** - File list (not code)

**Active usage**: Only ModalViewBuilder actually uses ModalDestination enum

### ActionRouter References (Many files)
- ContentView.swift - Primary routing
- ActionRegistry.swift - Action definitions
- ModalViewBuilder.swift - Modal construction
- All action modal files (46 modals)

---

## Migration Strategy

### Option 1: Remove ModalRouter Entirely (RECOMMENDED)

**Steps**:
1. ✅ Confirm ALL cards have `suggestedActions` (already verified)
2. Remove legacy routing branch from ContentView (lines 187-194)
3. Delete ModalRouter.swift (669 lines)
4. Update ModalViewBuilder to only use ActionRouter
5. Remove unused modal destination cases from ActionRouter
6. Delete ActionOptionsModalV1_1.swift (legacy action selector)

**Benefits**:
- ~700 lines of dead code removed
- Single source of truth for routing
- No duplicate logic maintenance
- Clearer architecture

**Risks**:
- LOW - Code path never executed
- Need to verify backend always returns suggestedActions

### Option 2: Deprecate Gradually (NOT RECOMMENDED)

**Steps**:
1. Mark ModalRouter as @available(*, deprecated)
2. Add logging to detect any usage
3. Monitor production for 1-2 weeks
4. Remove after confirmation

**Why not recommended**:
- Mock data already uses suggestedActions
- Backend confirmed to return suggestedActions
- No evidence of legacy card creation
- Unnecessary delay for known dead code

---

## Unused Action Modals (From Week 1)

These modals exist but are NOT wired into either routing system:

1. **AccountVerificationModal.swift** - Not found (may be deleted)
2. **RSVPModal.swift** - ActionRouter references it but .rsvp case doesn't exist
3. **ReviewSecurityModal.swift** - ActionRouter references it but case doesn't exist
4. **UpdatePaymentModal.swift** - ActionRouter references it but case doesn't exist
5. **ViewItineraryModal.swift** - Not wired anywhere
6. **ViewDetailsModal.swift** - Used as fallback but case doesn't match

**Decision**: Defer deletion until routing consolidation complete (Week 2 → Week 3)

---

## Backward Compatibility

### EmailCard Model (Models/EmailCard.swift)

```swift
// Legacy field (v1.0)
let hpa: String  // e.g., "View Summary"

// Modern field (v1.1)
let suggestedActions: [EmailAction]?

// Computed property for backward compatibility
var suggestedAction: String {
    return suggestedActions?.first(where: { $0.isPrimary })?.actionId ?? "view_document"
}
```

**Strategy**: Keep `hpa` field temporarily for backend compatibility, but stop using it in routing logic.

---

## Recommended Actions (Week 2)

### Immediate (Low Risk)
1. ✅ Create this audit document
2. Remove dead routing branch from ContentView
3. Add deprecation warnings to ModalRouter
4. Document findings in commit

### Short Term (Medium Risk)
5. Update ModalViewBuilder to only use ActionRouter
6. Remove ModalRouter.swift
7. Clean up dead modal destination references in ActionRouter
8. Delete ActionOptionsModalV1_1.swift

### Testing Requirements
- Verify all 46 modals still open correctly
- Test top 10 action flows (track package, pay invoice, etc.)
- Confirm no runtime crashes
- Check analytics for routing metrics

---

## Success Criteria

✅ Single routing system (ActionRouter only)
✅ Zero duplicate routing logic
✅ All modals still functional
✅ ~700 lines of dead code removed
✅ Clearer architecture for future development
✅ Build succeeds with zero errors
✅ No regressions in user-visible behavior

---

## Files to Modify

### Delete
- [ ] Navigation/ModalRouter.swift (669 lines)
- [ ] Views/ActionOptionsModalV1_1.swift (400 lines)

### Modify
- [ ] Zero/ContentView.swift (remove lines 187-194, dead routing branch)
- [ ] Navigation/ModalViewBuilder.swift (update to ActionRouter pattern)
- [ ] Services/ActionRouter.swift (remove dead modal cases: lines 558-581)

### Total Impact
- **Lines to delete**: ~1,069 lines
- **Files to delete**: 2 files
- **Files to modify**: 3 files
- **Risk level**: LOW (dead code removal)

---

**Audit Date**: 2025-11-14
**Status**: Week 2 Task 1 Complete
**Next Step**: Remove dead routing branch from ContentView
